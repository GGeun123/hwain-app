<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="analysis">
	<!-- 운행일지 카운트 조회 쿼리 -->
	<select id="analysisEquipCnt" parameterType="java.util.HashMap" resultType="java.util.HashMap">
		SELECT COUNT(*) AS LIST_CNT
		FROM (
			<if test="comboKey == '1'">
			    SELECT C.C002 AS EQUIP_CD
			            ,RIGHT(RTRIM(B.C072), 4) AS CAR_NUM
			            ,RTRIM(A.EMP_WORK1) AS USER_NAME
			            ,A.EQUIP_TP
			            ,A.TURN
			            ,A.INPUT_DT
						,CASE WHEN A.EMP_WORK1 IS NOT NULL THEN '1' ELSE '0' END AS TYPE_NUM
			    FROM SJ_SMARTFDB.dbo.EQUIP_WORK_INFO A
			        LEFT OUTER JOIN Hwinmm.dbo.TM0265 B ON A.EQUIP_TP = B.C001
			        LEFT OUTER JOIN Hwinmm.dbo.MV1010 C ON B.C030 = C.C001
				WHERE A.EMP_WORK1 IS NOT NULL
			    UNION ALL
			    SELECT C.C002 AS EQUIP_CD
			            ,RIGHT(RTRIM(B.C072), 4) AS CAR_NUM
			            ,RTRIM(A.EMP_WORK2) AS USER_NAME
			            ,A.EQUIP_TP
			            ,A.TURN
			            ,A.INPUT_DT
						,CASE WHEN A.EMP_WORK2 IS NOT NULL THEN '2' ELSE '0' END AS TYPE_NUM
			    FROM SJ_SMARTFDB.dbo.EQUIP_WORK_INFO A
			        LEFT OUTER JOIN Hwinmm.dbo.TM0265 B ON A.EQUIP_TP = B.C001
			        LEFT OUTER JOIN Hwinmm.dbo.MV1010 C ON B.C030 = C.C001
				WHERE A.EMP_WORK2 IS NOT NULL
			    UNION ALL
			    SELECT C.C002 AS EQUIP_CD
			            ,RIGHT(RTRIM(B.C072), 4) AS CAR_NUM
			            ,RTRIM(A.EMP_WORK3) AS USER_NAME
			            ,A.EQUIP_TP
			            ,A.TURN
			            ,A.INPUT_DT
						,CASE WHEN A.EMP_WORK3 IS NOT NULL THEN '3' ELSE '0' END AS TYPE_NUM
			    FROM SJ_SMARTFDB.dbo.EQUIP_WORK_INFO A
			        LEFT OUTER JOIN Hwinmm.dbo.TM0265 B ON A.EQUIP_TP = B.C001
			        LEFT OUTER JOIN Hwinmm.dbo.MV1010 C ON B.C030 = C.C001
				WHERE A.EMP_WORK3 IS NOT NULL
			</if>
			<if test="comboKey == '1'">
				SELECT C.C002 AS EQUIP_CD
			            ,RIGHT(RTRIM(B.C072), 4) AS CAR_NUM
			            ,RTRIM(A.EMP_WORK1) AS USER_NAME
			            ,A.EQUIP_TP
			            ,A.TURN
			            ,A.INPUT_DT
						,CASE WHEN A.EMP_WORK1 IS NOT NULL THEN '1' ELSE '0' END AS TYPE_NUM
			    FROM SJ_SMARTFDB.dbo.EQUIP_WORK_INFO A
			        LEFT OUTER JOIN Hwinmm.dbo.TM0265 B ON A.EQUIP_TP = B.C001
			        LEFT OUTER JOIN Hwinmm.dbo.MV1010 C ON B.C030 = C.C001
				WHERE A.EMP_WORK1 IS NOT NULL
			</if>
			<if test="comboKey == '2'">
				SELECT C.C002 AS EQUIP_CD
			            ,RIGHT(RTRIM(B.C072), 4) AS CAR_NUM
			            ,RTRIM(A.EMP_WORK2) AS USER_NAME
			            ,A.EQUIP_TP
			            ,A.TURN
			            ,A.INPUT_DT
						,CASE WHEN A.EMP_WORK2 IS NOT NULL THEN '2' ELSE '0' END AS TYPE_NUM
			    FROM SJ_SMARTFDB.dbo.EQUIP_WORK_INFO A
			        LEFT OUTER JOIN Hwinmm.dbo.TM0265 B ON A.EQUIP_TP = B.C001
			        LEFT OUTER JOIN Hwinmm.dbo.MV1010 C ON B.C030 = C.C001
				WHERE A.EMP_WORK2 IS NOT NULL
			</if>
			<if test="comboKey == '3'">
				SELECT C.C002 AS EQUIP_CD
			            ,RIGHT(RTRIM(B.C072), 4) AS CAR_NUM
			            ,RTRIM(A.EMP_WORK3) AS USER_NAME
			            ,A.EQUIP_TP
			            ,A.TURN
			            ,A.INPUT_DT
						,CASE WHEN A.EMP_WORK3 IS NOT NULL THEN '3' ELSE '0' END AS TYPE_NUM
			    FROM SJ_SMARTFDB.dbo.EQUIP_WORK_INFO A
			        LEFT OUTER JOIN Hwinmm.dbo.TM0265 B ON A.EQUIP_TP = B.C001
			        LEFT OUTER JOIN Hwinmm.dbo.MV1010 C ON B.C030 = C.C001
				WHERE A.EMP_WORK3 IS NOT NULL
			</if>
		) A
		WHERE INPUT_DT = #dates#
			AND (USER_NAME != '' AND USER_NAME IS NOT NULL)
	</select>
	
	<select id="analysisSLAGPOTListCnt" parameterType="java.util.HashMap" resultType="java.util.HashMap">
		SELECT COUNT(*) AS CNT 
		FROM SJ_SmartFDB.DBO.MANAGER_RPT_SLAG
		WHERE INPUT_DT = #dates#
	</select>
	
	<select id="analysisBreak" parameterType="java.util.HashMap" resultType="java.util.HashMap">
		SELECT RTRIM(ISNULL(BREAK_NUM, '0')) AS BREAK_NUM
				,RTRIM(ISNULL(BREAK_NAME, '')) AS BREAK_NAME
				,RTRIM(ISNULL(REMARKS, '')) AS REMARKS
		FROM SJ_SMARTFDB.dbo.EQUIP_WORK_INFO_MEMO
		WHERE INPUT_DT = #dates#
	</select>

	<!-- 운행일지 조회 쿼리 -->
	<select id="analysisEquipList" parameterType="java.util.HashMap" resultType="java.util.HashMap">
		SELECT REPLACE(ROW_NUMBER() OVER (ORDER BY EQUIP_TP), '.0', '') AS IDX
				,INPUT_DT
		        ,EQUIP_CD
		        ,CAR_NUM
		        ,USER_NAME
		        ,EQUIP_TP
				,TYPE_NUM
		FROM (
			<if test="comboKey == '0'">
			    SELECT C.C002 AS EQUIP_CD
			            ,RIGHT(RTRIM(B.C072), 4) AS CAR_NUM
			            ,RTRIM(A.EMP_WORK1) AS USER_NAME
			            ,A.EQUIP_TP
			            ,A.TURN
			            ,A.INPUT_DT
						,CASE WHEN A.EMP_WORK1 IS NOT NULL THEN '1' ELSE '0' END AS TYPE_NUM
			    FROM SJ_SMARTFDB.dbo.EQUIP_WORK_INFO A
			        LEFT OUTER JOIN Hwinmm.dbo.TM0265 B ON A.EQUIP_TP = B.C001
			        LEFT OUTER JOIN Hwinmm.dbo.MV1010 C ON B.C030 = C.C001
				WHERE A.EMP_WORK1 IS NOT NULL
			    UNION ALL
			    SELECT C.C002 AS EQUIP_CD
			            ,RIGHT(RTRIM(B.C072), 4) AS CAR_NUM
			            ,RTRIM(A.EMP_WORK2) AS USER_NAME
			            ,A.EQUIP_TP
			            ,A.TURN
			            ,A.INPUT_DT
						,CASE WHEN A.EMP_WORK2 IS NOT NULL THEN '2' ELSE '0' END AS TYPE_NUM
			    FROM SJ_SMARTFDB.dbo.EQUIP_WORK_INFO A
			        LEFT OUTER JOIN Hwinmm.dbo.TM0265 B ON A.EQUIP_TP = B.C001
			        LEFT OUTER JOIN Hwinmm.dbo.MV1010 C ON B.C030 = C.C001
				WHERE A.EMP_WORK2 IS NOT NULL
			    UNION ALL
			    SELECT C.C002 AS EQUIP_CD
			            ,RIGHT(RTRIM(B.C072), 4) AS CAR_NUM
			            ,RTRIM(A.EMP_WORK3) AS USER_NAME
			            ,A.EQUIP_TP
			            ,A.TURN
			            ,A.INPUT_DT
						,CASE WHEN A.EMP_WORK3 IS NOT NULL THEN '3' ELSE '0' END AS TYPE_NUM
			    FROM SJ_SMARTFDB.dbo.EQUIP_WORK_INFO A
			        LEFT OUTER JOIN Hwinmm.dbo.TM0265 B ON A.EQUIP_TP = B.C001
			        LEFT OUTER JOIN Hwinmm.dbo.MV1010 C ON B.C030 = C.C001
				WHERE A.EMP_WORK3 IS NOT NULL
			</if>
			<if test="comboKey == '1'">
				SELECT C.C002 AS EQUIP_CD
			            ,RIGHT(RTRIM(B.C072), 4) AS CAR_NUM
			            ,RTRIM(A.EMP_WORK1) AS USER_NAME
			            ,A.EQUIP_TP
			            ,A.TURN
			            ,A.INPUT_DT
						,CASE WHEN A.EMP_WORK1 IS NOT NULL THEN '1' ELSE '0' END AS TYPE_NUM
			    FROM SJ_SMARTFDB.dbo.EQUIP_WORK_INFO A
			        LEFT OUTER JOIN Hwinmm.dbo.TM0265 B ON A.EQUIP_TP = B.C001
			        LEFT OUTER JOIN Hwinmm.dbo.MV1010 C ON B.C030 = C.C001
				WHERE A.EMP_WORK1 IS NOT NULL
			</if>
			<if test="comboKey == '2'">
				SELECT C.C002 AS EQUIP_CD
			            ,RIGHT(RTRIM(B.C072), 4) AS CAR_NUM
			            ,RTRIM(A.EMP_WORK2) AS USER_NAME
			            ,A.EQUIP_TP
			            ,A.TURN
			            ,A.INPUT_DT
						,CASE WHEN A.EMP_WORK2 IS NOT NULL THEN '2' ELSE '0' END AS TYPE_NUM
			    FROM SJ_SMARTFDB.dbo.EQUIP_WORK_INFO A
			        LEFT OUTER JOIN Hwinmm.dbo.TM0265 B ON A.EQUIP_TP = B.C001
			        LEFT OUTER JOIN Hwinmm.dbo.MV1010 C ON B.C030 = C.C001
				WHERE A.EMP_WORK2 IS NOT NULL
			</if>
			<if test="comboKey == '3'">
				SELECT C.C002 AS EQUIP_CD
			            ,RIGHT(RTRIM(B.C072), 4) AS CAR_NUM
			            ,RTRIM(A.EMP_WORK3) AS USER_NAME
			            ,A.EQUIP_TP
			            ,A.TURN
			            ,A.INPUT_DT
						,CASE WHEN A.EMP_WORK3 IS NOT NULL THEN '3' ELSE '0' END AS TYPE_NUM
			    FROM SJ_SMARTFDB.dbo.EQUIP_WORK_INFO A
			        LEFT OUTER JOIN Hwinmm.dbo.TM0265 B ON A.EQUIP_TP = B.C001
			        LEFT OUTER JOIN Hwinmm.dbo.MV1010 C ON B.C030 = C.C001
				WHERE A.EMP_WORK3 IS NOT NULL
			</if>
		) A
		WHERE INPUT_DT = #dates#
			AND (USER_NAME != '' AND USER_NAME IS NOT NULL)
			<trim prefix="and">
		<if test="comboKey == '0'">
			TYPE_NUM = #comboKey#
		</if>
		ORDER BY INPUT_DT DESC, EQUIP_TP
		</trim>
	</select>
	
	<!-- S/P CARRIER 실적 리스트 조회 쿼리:해당 일자 데이터 없을 시 -->
	<select id="analysisSLAGPOTNoList" parameterType="java.util.HashMap" resultType="java.util.HashMap">
		SELECT REPLACE(ROW_NUMBER() OVER (ORDER BY A.PART_NM), '.0', '') AS IDX,
				A.PART_NM,
				REPLACE(ISNULL(A.DAY_VAL, 0), '.00', '') AS DAY_VAL,
				REPLACE(ISNULL(A.MON_VAL, 0), '.00', '') AS MON_VAL
		FROM (
			SELECT 'CEM(정련로)' AS PART_NM, INPUT_DT, SHIFTWORK_TP, (SELECT SUM(ISNULL(CEM1, 0) + ISNULL(CEM2, 0) + ISNULL(CEM3, 0)) FROM SJ_SmartFDB.DBO.MANAGER_RPT_SLAG WHERE INPUT_DT = #dates#) AS DAY_VAL, (SELECT SUM(ISNULL(CEM1, 0) + ISNULL(CEM2, 0) + ISNULL(CEM3, 0)) FROM SJ_SmartFDB.DBO.MANAGER_RPT_SLAG WHERE INPUT_DT BETWEEN CONVERT(VARCHAR(10), (SELECT DATEADD(D, -DAY(CONVERT(DATETIME, #dates#)-1), #dates#)), 102) AND #dates#) AS MON_VAL
			FROM SJ_SmartFDB.DBO.MANAGER_RPT_SLAG
			GROUP BY INPUT_DT, SHIFTWORK_TP
			UNION ALL
			SELECT '2제강KR' AS PART_NM, INPUT_DT, SHIFTWORK_TP, (SELECT SUM(ISNULL(IRON21, 0) + ISNULL(IRON22, 0) + ISNULL(IRON23, 0)) FROM SJ_SmartFDB.DBO.MANAGER_RPT_SLAG WHERE INPUT_DT = #dates#) AS DAY_VAL, (SELECT SUM(ISNULL(IRON21, 0) + ISNULL(IRON22, 0) + ISNULL(IRON23, 0)) FROM SJ_SmartFDB.DBO.MANAGER_RPT_SLAG WHERE INPUT_DT BETWEEN CONVERT(VARCHAR(10), (SELECT DATEADD(D, -DAY(CONVERT(DATETIME, #dates#)-1), #dates#)), 102) AND #dates#) AS MON_VAL
			FROM SJ_SmartFDB.DBO.MANAGER_RPT_SLAG
			GROUP BY INPUT_DT, SHIFTWORK_TP
			UNION ALL
			SELECT '예비처리 탈린로' AS PART_NM, INPUT_DT, SHIFTWORK_TP, (SELECT SUM(ISNULL(ETC1, 0) + ISNULL(ETC2, 0) + ISNULL(ETC3, 0)) FROM SJ_SmartFDB.DBO.MANAGER_RPT_SLAG WHERE INPUT_DT = #dates#) AS DAY_VAL, (SELECT SUM(ISNULL(ETC1, 0) + ISNULL(ETC2, 0) + ISNULL(ETC3, 0)) FROM SJ_SmartFDB.DBO.MANAGER_RPT_SLAG WHERE INPUT_DT BETWEEN CONVERT(VARCHAR(10), (SELECT DATEADD(D, -DAY(CONVERT(DATETIME, #dates#)-1), #dates#)), 102) AND #dates#) AS MON_VAL
			FROM SJ_SmartFDB.DBO.MANAGER_RPT_SLAG
			GROUP BY INPUT_DT, SHIFTWORK_TP
			UNION ALL
			SELECT '3제강K.R' AS PART_NM, INPUT_DT, SHIFTWORK_TP, (SELECT SUM(ISNULL(IRON31, 0) + ISNULL(IRON32, 0) + ISNULL(IRON33, 0)) FROM SJ_SmartFDB.DBO.MANAGER_RPT_SLAG WHERE INPUT_DT = #dates#) AS DAY_VAL, (SELECT SUM(ISNULL(IRON31, 0) + ISNULL(IRON32, 0) + ISNULL(IRON33, 0)) FROM SJ_SmartFDB.DBO.MANAGER_RPT_SLAG WHERE INPUT_DT BETWEEN CONVERT(VARCHAR(10), (SELECT DATEADD(D, -DAY(CONVERT(DATETIME, #dates#)-1), #dates#)), 102) AND #dates#) AS MON_VAL
			FROM SJ_SmartFDB.DBO.MANAGER_RPT_SLAG
			GROUP BY INPUT_DT, SHIFTWORK_TP
		) A
		GROUP BY PART_NM, DAY_VAL, MON_VAL
		ORDER BY PART_NM
	</select>
	
	<!-- S/P CARRIER 실적 리스트 조회 쿼리 -->
	<select id="analysisSLAGPOTList" parameterType="java.util.HashMap" resultType="java.util.HashMap">
		SELECT REPLACE(ROW_NUMBER() OVER (ORDER BY A.INPUT_DT), '.0', '') AS IDX,
				A.INPUT_DT,
				A.PART_NM,
				REPLACE(ISNULL(A.DAY_VAL, 0), '.00', '') AS DAY_VAL,
				REPLACE(ISNULL(A.MON_VAL, 0), '.00', '') AS MON_VAL
		FROM (
			SELECT 'CEM(정련로)' AS PART_NM, INPUT_DT, SHIFTWORK_TP, SUM(ISNULL(CEM1, 0) + ISNULL(CEM2, 0) + ISNULL(CEM3, 0)) AS DAY_VAL, (SELECT SUM(ISNULL(CEM1, 0) + ISNULL(CEM2, 0) + ISNULL(CEM3, 0)) FROM SJ_SmartFDB.DBO.MANAGER_RPT_SLAG WHERE INPUT_DT BETWEEN CONVERT(VARCHAR(10), (SELECT DATEADD(D, -DAY(CONVERT(DATETIME, #dates#)-1), #dates#)), 102) AND #dates#) AS MON_VAL
			FROM SJ_SmartFDB.DBO.MANAGER_RPT_SLAG
			GROUP BY INPUT_DT, SHIFTWORK_TP
			UNION ALL
			SELECT '2제강KR' AS PART_NM, INPUT_DT, SHIFTWORK_TP, SUM(ISNULL(IRON21, 0) + ISNULL(IRON22, 0) + ISNULL(IRON23, 0)) AS DAY_VAL, (SELECT SUM(ISNULL(IRON21, 0) + ISNULL(IRON22, 0) + ISNULL(IRON23, 0)) FROM SJ_SmartFDB.DBO.MANAGER_RPT_SLAG WHERE INPUT_DT BETWEEN CONVERT(VARCHAR(10), (SELECT DATEADD(D, -DAY(CONVERT(DATETIME, #dates#)-1), #dates#)), 102) AND #dates#) AS MON_VAL
			FROM SJ_SmartFDB.DBO.MANAGER_RPT_SLAG
			GROUP BY INPUT_DT, SHIFTWORK_TP
			UNION ALL
			SELECT '예비처리 탈린로' AS PART_NM, INPUT_DT, SHIFTWORK_TP, SUM(ISNULL(ETC1, 0) + ISNULL(ETC2, 0) + ISNULL(ETC3, 0)) AS DAY_VAL, (SELECT SUM(ISNULL(ETC1, 0) + ISNULL(ETC2, 0) + ISNULL(ETC3, 0)) FROM SJ_SmartFDB.DBO.MANAGER_RPT_SLAG WHERE INPUT_DT BETWEEN CONVERT(VARCHAR(10), (SELECT DATEADD(D, -DAY(CONVERT(DATETIME, #dates#)-1), #dates#)), 102) AND #dates#) AS MON_VAL
			FROM SJ_SmartFDB.DBO.MANAGER_RPT_SLAG
			GROUP BY INPUT_DT, SHIFTWORK_TP
			UNION ALL
			SELECT '3제강K.R' AS PART_NM, INPUT_DT, SHIFTWORK_TP, SUM(ISNULL(IRON31, 0) + ISNULL(IRON32, 0) + ISNULL(IRON33, 0)) AS DAY_VAL, (SELECT SUM(ISNULL(IRON31, 0) + ISNULL(IRON32, 0) + ISNULL(IRON33, 0)) FROM SJ_SmartFDB.DBO.MANAGER_RPT_SLAG WHERE INPUT_DT BETWEEN CONVERT(VARCHAR(10), (SELECT DATEADD(D, -DAY(CONVERT(DATETIME, #dates#)-1), #dates#)), 102) AND #dates#) AS MON_VAL
			FROM SJ_SmartFDB.DBO.MANAGER_RPT_SLAG
			GROUP BY INPUT_DT, SHIFTWORK_TP
		) A
		WHERE A.INPUT_DT = #dates#
		ORDER BY PART_NM
	</select>
</mapper>